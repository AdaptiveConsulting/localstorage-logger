var Node_1 = require('./Node');
/**
 * This class keeps track of the start, end and size of the queue
 * stored in local storage. It allows nodes to be created and removed.
 */
var Bookkeeper = (function () {
    /**
     * Creates a new Bookkeeper for a queue. It should be initialized using reset method.
     */
    function Bookkeeper(_config) {
        this._config = _config;
    }
    /**
     * Stores the current state of the queue to local storage.
     */
    Bookkeeper.prototype.store = function () {
        try {
            var serializedInfo = JSON.stringify(this._info);
            // Ideally this would all be inside a transaction {
            this._removed.forEach(function (node) { return node.remove(); });
            this._added.forEach(function (node) { return node.store(); });
            localStorage.setItem(this._config.keyPrefix, serializedInfo);
        }
        finally {
            this._added = [];
            this._removed = [];
        }
    };
    /**
     * Resets the start, end and size counts to what was last persisted to
     * local storage.
     */
    Bookkeeper.prototype.reset = function () {
        this._added = [];
        this._removed = [];
        var serializedInfo = localStorage.getItem(this._config.keyPrefix);
        if (serializedInfo === null) {
            this._info = {
                sizeInBytes: 0,
                startIndex: 0,
                nextFreeIndex: 0
            };
            this.store();
        }
        else {
            this._info = JSON.parse(serializedInfo);
        }
    };
    /**
     * Returns true if the queue has no elements.
     */
    Bookkeeper.prototype.isEmpty = function () {
        return this._info.sizeInBytes === 0;
    };
    /**
     * Calculates the projected free space. This takes into account modifications.
     */
    Bookkeeper.prototype.remainingSpace = function () {
        return this._config.maxSizeInBytes - this._info.sizeInBytes;
    };
    /**
     * Creates a new node at the end of the queue.
     * @param value The value to store as an element of the queue.
     */
    Bookkeeper.prototype.createNextNode = function (value) {
        var node = new Node_1.Node(this._config, this._info.nextFreeIndex, value);
        this._info.nextFreeIndex = this._nextIndex(this._info.nextFreeIndex);
        this._info.sizeInBytes += node.estimatedSize();
        this._added.push(node);
        return node;
    };
    /**
     * Removes and returns the first stored node. The consumer should check that there is a node to remove first.
     */
    Bookkeeper.prototype.deleteFirstNode = function () {
        var node = Node_1.Node.fromLocalStorage(this._config, this._info.startIndex);
        this._info.startIndex = this._nextIndex(this._info.startIndex);
        this._info.sizeInBytes -= node.estimatedSize();
        this._removed.push(node);
        return node;
    };
    /**
     * Iterates through the index values of the elements in the queue. These can be used to retrieve the elements.
     * @param callback The function that will be invoked once for each index value used in the queue.
     */
    Bookkeeper.prototype.iterateIndexValues = function (callback) {
        for (var i = this._info.startIndex; i !== this._info.nextFreeIndex; i = this._nextIndex(i)) {
            callback(i);
        }
    };
    /**
     * Returns the next index value (modulo MAX_SAFE_INTEGER).
     * @param index The previous index value.
     */
    Bookkeeper.prototype._nextIndex = function (index) {
        var MAX_SAFE_INTEGER = 9007199254740991;
        return (index + 1) % MAX_SAFE_INTEGER;
    };
    return Bookkeeper;
})();
exports.Bookkeeper = Bookkeeper;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInF1ZXVlL0Jvb2trZWVwZXIudHMiXSwibmFtZXMiOlsiQm9va2tlZXBlciIsIkJvb2trZWVwZXIuY29uc3RydWN0b3IiLCJCb29ra2VlcGVyLnN0b3JlIiwiQm9va2tlZXBlci5yZXNldCIsIkJvb2trZWVwZXIuaXNFbXB0eSIsIkJvb2trZWVwZXIucmVtYWluaW5nU3BhY2UiLCJCb29ra2VlcGVyLmNyZWF0ZU5leHROb2RlIiwiQm9va2tlZXBlci5kZWxldGVGaXJzdE5vZGUiLCJCb29ra2VlcGVyLml0ZXJhdGVJbmRleFZhbHVlcyIsIkJvb2trZWVwZXIuX25leHRJbmRleCJdLCJtYXBwaW5ncyI6IkFBRUEscUJBQW1CLFFBQVEsQ0FBQyxDQUFBO0FBRTVCOzs7R0FHRztBQUNIO0lBS0VBOztPQUVHQTtJQUNIQSxvQkFBb0JBLE9BQTRCQTtRQUE1QkMsWUFBT0EsR0FBUEEsT0FBT0EsQ0FBcUJBO0lBQ2hEQSxDQUFDQTtJQUVERDs7T0FFR0E7SUFDSEEsMEJBQUtBLEdBQUxBO1FBQ0VFLElBQUlBLENBQUNBO1lBQ0hBLElBQU1BLGNBQWNBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBQ2xEQSxtREFBbURBO1lBQ25EQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFBQSxJQUFJQSxJQUFJQSxPQUFBQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxFQUFiQSxDQUFhQSxDQUFDQSxDQUFDQTtZQUM3Q0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBQUEsSUFBSUEsSUFBSUEsT0FBQUEsSUFBSUEsQ0FBQ0EsS0FBS0EsRUFBRUEsRUFBWkEsQ0FBWUEsQ0FBQ0EsQ0FBQ0E7WUFDMUNBLFlBQVlBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLEVBQUVBLGNBQWNBLENBQUNBLENBQUNBO1FBRS9EQSxDQUFD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Q0E7SUFDZEEsQ0FBQ0E7SUFFRFA7OztPQUdHQTtJQUNIQSx1Q0FBa0JBLEdBQWxCQSxVQUFtQkEsUUFBZ0NBO1FBQ2pEUSxHQUFHQSxDQUFBQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxLQUFLQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxhQUFhQSxFQUFFQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQTtZQUMxRkEsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDZEEsQ0FBQ0E7SUFDSEEsQ0FBQ0E7SUFFRFI7OztPQUdHQTtJQUNIQSwrQkFBVUEsR0FBVkEsVUFBV0EsS0FBYUE7UUFDdEJTLElBQU1BLGdCQUFnQkEsR0FBR0EsZ0JBQWdCQSxDQUFDQTtRQUMxQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsZ0JBQWdCQSxDQUFDQTtJQUN4Q0EsQ0FBQ0E7SUFDSFQsaUJBQUNBO0FBQURBLENBdkdBLEFBdUdDQSxJQUFBO0FBdkdZLGtCQUFVLGFBdUd0QixDQUFBIiwiZmlsZSI6InF1ZXVlL0Jvb2trZWVwZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0lRdWV1ZUNvbmZpZ3VyYXRpb259IGZyb20gJy4vSVF1ZXVlQ29uZmlndXJhdGlvbic7XG5pbXBvcnQge0lCb29ra2VlcGluZ0luZm99IGZyb20gJy4vSUJvb2trZWVwaW5nSW5mbyc7XG5pbXBvcnQge05vZGV9IGZyb20gJy4vTm9kZSc7XG5cbi8qKlxuICogVGhpcyBjbGFzcyBrZWVwcyB0cmFjayBvZiB0aGUgc3RhcnQsIGVuZCBhbmQgc2l6ZSBvZiB0aGUgcXVldWVcbiAqIHN0b3JlZCBpbiBsb2NhbCBzdG9yYWdlLiBJdCBhbGxvd3Mgbm9kZXMgdG8gYmUgY3JlYXRlZCBhbmQgcmVtb3ZlZC5cbiAqLyBcbmV4cG9ydCBjbGFzcyBCb29ra2VlcGVyPFQ+IHtcbiAgcHJpdmF0ZSBfaW5mbzogSUJvb2trZWVwaW5nSW5mbzsgXG4gIHByaXZhdGUgX2FkZGVkOiBBcnJheTxOb2RlPFQ+PjtcbiAgcHJpdmF0ZSBfcmVtb3ZlZDogQXJyYXk8Tm9kZTxUPj47XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBuZXcgQm9va2tlZXBlciBmb3IgYSBxdWV1ZS4gSXQgc2hvdWxkIGJlIGluaXRpYWxpemVkIHVzaW5nIHJlc2V0IG1ldGhvZC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgX2NvbmZpZzogSVF1ZXVlQ29uZmlndXJhdGlvbikge1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3JlcyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcXVldWUgdG8gbG9jYWwgc3RvcmFnZS5cbiAgICovXG4gIHN0b3JlKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZXJpYWxpemVkSW5mbyA9IEpTT04uc3RyaW5naWZ5KHRoaXMuX2luZm8pO1xuICAgICAgLy8gSWRlYWxseSB0aGlzIHdvdWxkIGFsbCBiZSBpbnNpZGUgYSB0cmFuc2FjdGlvbiB7XG4gICAgICB0aGlzLl9yZW1vdmVkLmZvckVhY2gobm9kZSA9PiBub2RlLnJlbW92ZSgpKTtcbiAgICAgIHRoaXMuX2FkZGVkLmZvckVhY2gobm9kZSA9PiBub2RlLnN0b3JlKCkpO1xuICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5fY29uZmlnLmtleVByZWZpeCwgc2VyaWFsaXplZEluZm8pO1xuICAgICAgLy8gfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLl9hZGRlZCA9IFtdO1xuICAgICAgdGhpcy5fcmVtb3ZlZCA9IFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldHMgdGhlIHN0YXJ0LCBlbmQgYW5kIHNpemUgY291bnRzIHRvIHdoYXQgd2FzIGxhc3QgcGVyc2lzdGVkIHRvXG4gICAqIGxvY2FsIHN0b3JhZ2UuXG4gICAqL1xuICByZXNldCgpIHtcbiAgICB0aGlzLl9hZGRlZCA9IFtdO1xuICAgIHRoaXMuX3JlbW92ZWQgPSBbXTtcbiAgICBjb25zdCBzZXJpYWxpemVkSW5mbyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMuX2NvbmZpZy5rZXlQcmVmaXgpO1xuICAgIGlmIChzZXJpYWxpemVkSW5mbyA9PT0gbnVsbCkge1xuICAgICAgdGhpcy5faW5mbyA9IHtcbiAgICAgICAgc2l6ZUluQnl0ZXM6IDAsXG4gICAgICAgIHN0YXJ0SW5kZXg6IDAsXG4gICAgICAgIG5leHRGcmVlSW5kZXg6IDBcbiAgICAgIH07XG4gICAgICB0aGlzLnN0b3JlKCk7IFxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbmZvID0gSlNPTi5wYXJzZShzZXJpYWxpemVkSW5mbyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgcXVldWUgaGFzIG5vIGVsZW1lbnRzLlxuICAgKi9cbiAgaXNFbXB0eSgpIHtcbiAgICByZXR1cm4gdGhpcy5faW5mby5zaXplSW5CeXRlcyA9PT0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGVzIHRoZSBwcm9qZWN0ZWQgZnJlZSBzcGFjZS4gVGhpcyB0YWtlcyBpbnRvIGFjY291bnQgbW9kaWZpY2F0aW9ucy5cbiAgICovXG4gIHJlbWFpbmluZ1NwYWNlKCkge1xuICAgIHJldHVybiB0aGlzLl9jb25maWcubWF4U2l6ZUluQnl0ZXMgLSB0aGlzLl9pbmZvLnNpemVJbkJ5dGVzO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBuZXcgbm9kZSBhdCB0aGUgZW5kIG9mIHRoZSBxdWV1ZS5cbiAgICogQHBhcmFtIHZhbHVlIFRoZSB2YWx1ZSB0byBzdG9yZSBhcyBhbiBlbGVtZW50IG9mIHRoZSBxdWV1ZS5cbiAgICovXG4gIGNyZWF0ZU5leHROb2RlKHZhbHVlOiBUKSB7XG4gICAgY29uc3Qgbm9kZSA9IG5ldyBOb2RlPFQ+KHRoaXMuX2NvbmZpZywgdGhpcy5faW5mby5uZXh0RnJlZUluZGV4LCB2YWx1ZSk7XG4gICAgdGhpcy5faW5mby5uZXh0RnJlZUluZGV4ID0gdGhpcy5fbmV4dEluZGV4KHRoaXMuX2luZm8ubmV4dEZyZWVJbmRleCk7XG4gICAgdGhpcy5faW5mby5zaXplSW5CeXRlcyArPSBub2RlLmVzdGltYXRlZFNpemUoKTtcbiAgICB0aGlzLl9hZGRlZC5wdXNoKG5vZGUpO1xuICAgIHJldHVybiBub2RlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgYW5kIHJldHVybnMgdGhlIGZpcnN0IHN0b3JlZCBub2RlLiBUaGUgY29uc3VtZXIgc2hvdWxkIGNoZWNrIHRoYXQgdGhlcmUgaXMgYSBub2RlIHRvIHJlbW92ZSBmaXJzdC5cbiAgICovXG4gIGRlbGV0ZUZpcnN0Tm9kZSgpIHtcbiAgICBjb25zdCBub2RlID0gTm9kZS5mcm9tTG9jYWxTdG9yYWdlPFQ+KHRoaXMuX2NvbmZpZywgdGhpcy5faW5mby5zdGFydEluZGV4KTtcbiAgICB0aGlzLl9pbmZvLnN0YXJ0SW5kZXggPSB0aGlzLl9uZXh0SW5kZXgodGhpcy5faW5mby5zdGFydEluZGV4KTtcbiAgICB0aGlzLl9pbmZvLnNpemVJbkJ5dGVzIC09IG5vZGUuZXN0aW1hdGVkU2l6ZSgpO1xuICAgIHRoaXMuX3JlbW92ZWQucHVzaChub2RlKTtcbiAgICByZXR1cm4gbm9kZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJdGVyYXRlcyB0aHJvdWdoIHRoZSBpbmRleCB2YWx1ZXMgb2YgdGhlIGVsZW1lbnRzIGluIHRoZSBxdWV1ZS4gVGhlc2UgY2FuIGJlIHVzZWQgdG8gcmV0cmlldmUgdGhlIGVsZW1lbnRzLlxuICAgKiBAcGFyYW0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBpbnZva2VkIG9uY2UgZm9yIGVhY2ggaW5kZXggdmFsdWUgdXNlZCBpbiB0aGUgcXVldWUuXG4gICAqL1xuICBpdGVyYXRlSW5kZXhWYWx1ZXMoY2FsbGJhY2s6IChpbmRleDpudW1iZXIpID0+IHZvaWQpIHtcbiAgICBmb3IobGV0IGkgPSB0aGlzLl9pbmZvLnN0YXJ0SW5kZXg7IGkgIT09IHRoaXMuX2luZm8ubmV4dEZyZWVJbmRleDsgaSA9IHRoaXMuX25leHRJbmRleChpKSkge1xuICAgICAgY2FsbGJhY2soaSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIG5leHQgaW5kZXggdmFsdWUgKG1vZHVsbyBNQVhfU0FGRV9JTlRFR0VSKS5cbiAgICogQHBhcmFtIGluZGV4IFRoZSBwcmV2aW91cyBpbmRleCB2YWx1ZS5cbiAgICovXG4gIF9uZXh0SW5kZXgoaW5kZXg6IG51bWJlcikge1xuICAgIGNvbnN0IE1BWF9TQUZFX0lOVEVHRVIgPSA5MDA3MTk5MjU0NzQwOTkxO1xuICAgIHJldHVybiAoaW5kZXggKyAxKSAlIE1BWF9TQUZFX0lOVEVHRVI7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
